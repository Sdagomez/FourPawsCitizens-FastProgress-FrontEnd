<html>

<head>

    <title>Four Pets Citizens</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css"
        integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js"
        integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js"
        integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k"
        crossorigin="anonymous"></script>
    <script src="http://code.jquery.com/jquery-3.3.1.min.js"
        integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.19/css/jquery.dataTables.min.css">
    <script src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
    <script src="Javascript/Navigation.js"></script>
    <link rel="stylesheet" href="css/styles.css" type="text/css">
</head>
<!-- Navigation of the owner interface -->
<nav>
    <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" id="register-tab" data-toggle="tab" href="#register" role="tab"
                aria-controls="register" aria-selected="true">Registrar Mascota</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="update-tab" data-toggle="tab" href="#update" role="tab" aria-controls="update"
                aria-selected="false">Actualizar Mascota</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="petCase-tab" data-toggle="tab" href="#petCase" role="tab" aria-controls="petCase"
                aria-selected="false">Crear Caso</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="find-tab" data-toggle="tab" href="#find" role="tab" aria-controls="find"
                aria-selected="false">Tabla de Mascotas</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="CaseAndVisits-tab" data-toggle="tab" href="#CaseAndVisits" role="tab"
                aria-controls="CaseAndVisits" aria-selected="false">Tabla de casos y visitas por mascota</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="Upuser-tab" data-toggle="tab" href="#Upuser" role="tab" aria-controls="Upuser"
                aria-selected="false">Cambiar datos de propietario</a>
        </li>
    </ul>
</nav>

<body class="ownerBack">

    <div class="tab-content" id="myTabContent">
        <div class="tab-pane fade show active" id="register" role="tabpanel" aria-labelledby="register-tab"
            align="center">

            <div class="configureStyleMainForms">

                <!--Form for creation of owner's pet-->
                <form action="Createpatsform" autocomplete="off" id="formC" name="formC">
                    <fieldset>
                        <legend> Formulario de Registro de mascotas</legend>
                        <label for="microchip">Ingrese su microchip:</label><br>
                        <input type="text" name="microchip" size="30" id="microchip" placeholder="Ej: 123456789">
                        <br>
                        <br>
                        <label for="name">Ingrese su nombre de la mascota:</label><br>
                        <input type="text" name="name" size="30" id="name" placeholder="Ej: Sammy" required>
                        <br>
                        <br>
                        <label for="species">Seleccione la especie:</label><br>
                        <select name="species" id="species" required>
                            <option value="" selected="selected">Seleccione</option>
                            <option value="2">Canino</option>
                            <option value="3">Felino</option>
                        </select>
                        <br>
                        <br>

                        <label for="sex"> Seleccione el sexo:</label><br>
                        <select name="sex" id="sex" required>
                            <option value="" selected="selected">Seleccione</option>
                            <option value="2">Macho</option>
                            <option value="3">Hembra</option>
                        </select>
                        <br>
                        <br>
                        <label for="size">Seleccione el tamaño:</label><br>
                        <select name="size" id="size" required>
                            <option value="" selected="selected">Seleccione</option>
                            <option value="2">Muy Grande</option>
                            <option value="3">Grande</option>
                            <option value="4">Mediano</option>
                            <option value="4">Pequeño</option>
                            <option value="4">Miniatura</option>
                        </select>
                        <br>
                        <br>
                        <label for="race">Seleccione la raza:</label><br>
                        <input type="text" name="race" size="30" id="race" placeholder="Ej: Pastor Aleman" required>
                        <br>
                        <br>
                        <label for="imagePet"> Imagen de la mascota
                        </label><br>
                        <input type="file" name="imagePet" size="30" id="imagePet" required>
                        <br>
                        <br>
                        <p align="center">
                            <button type="button" id="Cpets">Crear mascota</button>
                        </p>
                    </fieldset>
                </form>

            </div>
        </div>
        <div class="tab-pane fade" id="update" role="tabpanel" aria-labelledby="update-tab" align="center">
            <div class="configureStyleMainForms">

                <!--Form for the update of owner's pet -->
                <form action="Uppetsform" autocomplete="off" name="formU" id="formU">
                    <fieldset>
                        <legend> Formulario de Actualizar de mascotas</legend>
                        <label for="petid">ID de la mascota:</label><br>
                        <input id="petid" type="text" name="petid" required disabled>
                        <br>
                        <br>
                        <label for="nameU">Ingrese su nombre de la mascota:</label><br>
                        <input type="text" name="nameU" size="30" id="nameU" placeholder="Ej: Sammy" required>
                        <br>
                        <br>
                        <label for="microchipU">Ingrese su microchip:</label><br>
                        <input type="text" name="microchipU" size="30" id="microchipU" placeholder="Ej: 123456789">
                        <br>
                        <br>

                        <label for="speciesU">Seleccione la especie:</label><br>
                        <select name="speciesU" id="speciesU" required>
                            <option value="" selected="selected">Seleccione</option>
                            <option value="2">Canino</option>
                            <option value="3">Felino</option>
                        </select>
                        <br>
                        <br>

                        <label for="sexU"> Seleccione el sexo:</label><br>
                        <select name="sexU" id="sexU" required>
                            <option value="" selected="selected">Seleccione</option>
                            <option value="2">Macho</option>
                            <option value="3">Hembra</option>
                        </select>
                        <br>
                        <br>
                        <label for="sizeU">Seleccione el tamaño:</label><br>
                        <select name="sizeU" id="sizeU" required>
                            <option value="" selected="selected">Seleccione</option>
                            <option value="2">Muy Grande</option>
                            <option value="3">Grande</option>
                            <option value="4">Mediano</option>
                            <option value="4">Pequeño</option>
                            <option value="4">Miniatura</option>
                        </select>
                        <br>
                        <br>
                        <label for="raceU">Seleccione la raza:</label><br>
                        <input type="text" name="raceU" size="30" id="raceU" placeholder="Ej: Pastor Aleman" required>
                        <br>
                        <br>
                        <label for="imagePetU"> Imagen de la mascota
                        </label><br>
                        <input type="file" name="imagePetU" size="30" id="imagePetU" required>
                        <br>
                        <br>
                        <p align="center">
                            <button type="button" id="Upets">Actualizar mascota</button>
                        </p>
                    </fieldset>
                </form>

            </div>

        </div>
        <div class="tab-pane fade" id="petCase" role="tabpanel" aria-labelledby="petCase-tab" align="center">
            <div class="configureStyleMainForms">
                <!--Form for the creation of a case -->
                <form name="formCase" autocomplete="off" id="formCase">
                    <fieldset>
                        <legend> Crear Caso</legend>
                        <label for="petidC">ID de la mascota:</label><br>
                        <input id="petidC" type="text" name="petidC" disabled required>
                        <br>
                        <br>
                        <label for="caseDate"> Fecha del caso</label><br>
                        <input type="Date" name="caseDate" size="30" id="caseDate" required>
                        <br>
                        <br>
                        <label for="typeCase">Tipo de caso:</label><br>
                        <select id="typeCase" name="typeCase" required>
                            <option value="" selected="selected">Seleccione</option>
                            <option value="2">Perdida</option>
                            <option value="3">Robo</option>
                            <option value="4">Fallecimiento</option>
                        </select>
                        <br>
                        <br>
                        <label for="description">Descripción:</label><br>
                        <input type="text" name="description" size="30" id="description"
                            placeholder="Ej: La mascota estaba" required>
                        <br>
                        <br>

                        <p align="center">
                            <button type="button" id="caseB">Actualizar datos</button>
                        </p>
                    </fieldset>
                </form>
            </div>
        </div>
        <div class="tab-pane fade" id="find" role="tabpanel" aria-labelledby="find-tab" align="center">
            <div class="configureStyleMainBox">

                <!-- Table to shows all the vets for an specific owner -->
                <h2 class="titles">Tabla de Mascotas del Propietario</h2>
                <table id="myTableOwner" class="table table-fluid">
                    <thead>
                        <tr>
                            <th scope="col">Actualizar</th>
                            <th scope="col">ID</th>
                            <th scope="col">microchip</th>
                            <th scope="col">nombre</th>
                            <th scope="col">especie</th>
                            <th scope="col">raza</th>
                            <th scope="col">tamaños</th>
                            <th scope="col">sexo</th>
                            <th scope="col">imagen</th>
                            <th scope="col">Crear Caso</th>
                            <th scope="col">Ver casos y visitas</th>
                        </tr>
                    </thead>
                </table>
            </div>
        </div>
        <div class="tab-pane fade" id="CaseAndVisits" role="tabpanel" aria-labelledby="CaseAndVisits-tab"
            align="center">
            <div class="configureStyleMainBox">
                <!-- Table to list all cases and visits of an owner's pets-->
                <h3 class="titles">Busqueda de casos y visitas por fechas</h3>
                <h5>Filtrar</h5>
                <!-- Name and date filters for the cases and visits table-->
                <form name="formTCV" id="formTCV">
                    <label for="Date1"> Primer rango de fecha</label><br>
                    <input type="Date" name="Date1" size="30" id="Date1" required>
                    <br>
                    <br>
                    <label for="Date2"> Segundo rango de fecha</label><br>
                    <input type="Date" name="Date2" size="30" id="Date2" required>
                    <br>
                    <br>
                    <button class="btn btn-rounded btn-primary" id="filter" type="button">Filtrar</button>
                </form>

                <br>
                <div id="OwnerTableVisitsCase" align="center">
                    <table id="myTableCaseVisitOwner" class="table table-fluid">
                        <thead>
                            <tr>
                                <th scope="col">Fecha</th>
                                <th scope="col">Caso o Visita</th>
                                <th scope="col">ID del Caso o Visita</th>
                                <th scope="col">Nombre de la Mascota</th>
                                <th scope="col">Tipo</th>
                                <th scope="col">descripción</th>
                                <th scope="col">Nombre de la Veterinaria</th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="Upuser" role="tabpanel" aria-labelledby="Upuser-tab" align="center">
            <div class="configureStyleMainForms">
                <!--Form to update the owner's data-->
                <form name="formUser" autocomplete="off" id="formUser">
                    <fieldset>
                        <legend> Formulario de Actualizar Datos del Propietario</legend>
                        <br>
                        <label for="neighborhoodUser">Seleccione la localidad:</label><br>
                        <select id="neighborhoodUser" name="neighborhoodUser" required>
                            <option value="" selected="selected">Seleccione</option>
                            <option value="2">Usaquen</option>
                            <option value="3">Chapinero</option>
                            <option value="4">Santa Fe</option>
                            <option value="5">San Cristobal</option>
                            <option value="6">Usme</option>
                            <option value="7">Tunjuelito</option>
                            <option value="8">Bosa</option>
                            <option value="9">Kennedy</option>
                            <option value="10">Fontibon</option>
                            <option value="11">Engativa</option>
                            <option value="12">Suba</option>
                            <option value="13">Barrios Unidos</option>
                            <option value="14">Teusaquillo</option>
                            <option value="15">Los Martires</option>
                            <option value="16">Antonio Nariño</option>
                            <option value="17">Puente Aranda</option>
                            <option value="18">La Candelaria</option>
                            <option value="19">Uribe</option>
                            <option value="20">Ciudad Bolivar</option>
                            <option value="21">Sumapaz</option>
                            <option value="22">Municipios aledaños</option>
                        </select>
                        <br>
                        <br>
                        <label for="addressUser">Digite la dirección:</label><br>
                        <input type="text" name="addressUser" size="30" id="addressUser"
                            placeholder="Ej: Cr 7 # 100 - 10" required>
                        <br>
                        <br>

                        <p align="center">
                            <button type="button" id="Uuser">Actualizar datos</button>
                        </p>
                    </fieldset>
                </form>
            </div>
        </div>
        <script type="text/javascript">
            var Cbutton = document.getElementById("Cpets");
            var Ubutton = document.getElementById("Upets");
            var Casebutton = document.getElementById("caseB");
            var Userbutton = document.getElementById("Uuser");

            /**
             * Find the username in the url
             * @returns {string}
             */
            function findUsername() {
                var url = window.location.href
                var part = url.split("?");
                return (part[1])
            }

            /**
             * Get the parameters of the form and send it to the rest in backend for create a pet
             */
            Cbutton.onclick = function () {
                var photo = document.getElementById("imagePet");
                var url = 'http://localhost:8080/FourPawsCitizens-FootprintsSystem-1.0-SNAPSHOT/api/upload';

                const formData = new FormData();
                formData.append('file', photo.files[0]);

                fetch(url, {
                    method: 'POST',
                    body: formData
                }).then(res => res.text())
                    .then(res => createPet(res));
            }

            function createPet(fileD) {
                var username = findUsername();
                var microchip
                var url = 'http://localhost:8080/FourPawsCitizens-FootprintsSystem-1.0-SNAPSHOT/api/owners/' + username + '/pets';
                if (document.getElementById("microchip").value === "") {
                    microchip = null;
                } else {
                    microchip = Number(document.getElementById("microchip").value)
                }
                if (isNaN(microchip) || document.formC.species[document.formC.species.selectedIndex].text === "Seleccione"
                    || document.formC.size[document.formC.size.selectedIndex].text === "Seleccione" || document.formC.sex[document.formC.sex.selectedIndex].text === "Seleccione"
                    || fileD === "unknown") {
                    alert("Los datos ingresados son incorrectos");
                    return;
                }
                var data = {
                    "microchip": microchip,
                    "name": document.getElementById("name").value,
                    "species": document.formC.species[document.formC.species.selectedIndex].text,
                    "race": document.getElementById("race").value,
                    "size": document.formC.size[document.formC.size.selectedIndex].text,
                    "sex": document.formC.sex[document.formC.sex.selectedIndex].text,
                    "picture": fileD
                };
                fetch(url, {
                    method: 'POST',
                    body: JSON.stringify(data), // data can be `string` or {object}!
                    headers: {
                        'Content-Type': 'application/json'
                    }
                }).then(res => res.text())
                    .then(res => validateNewPet(res));
            }

            /**
             * Validate the register of a pet
             * @param res string message
             */
            function validateNewPet(res) {
                if (res === "se ha registrado correctamente") {
                    alert("Se creo la mascota correctamente");
                } else {
                    alert(res.toString());
                }
                location.reload();
            }

            /**
             * Get the parameters of the form and send it to the rest in backend for update a pet
             */
            Ubutton.onclick = function () {
                var photo = document.getElementById("imagePetU");
                var url = 'http://localhost:8080/FourPawsCitizens-FootprintsSystem-1.0-SNAPSHOT/api/upload';

                const formData = new FormData();
                formData.append('file', photo.files[0]);

                fetch(url, {
                    method: 'POST',
                    body: formData
                }).then(res => res.text())
                    .then(res => updatePet(res));
            }

            function updatePet(fileD) {
                var username = findUsername();
                var pet_id = Number(document.getElementById("petid").value);
                var microchip
                var url = 'http://localhost:8080/FourPawsCitizens-FootprintsSystem-1.0-SNAPSHOT/api/owners/' + username + '/pets/' + pet_id;
                if (document.getElementById("microchipU").value === "") {
                    microchip = null;
                } else {
                    microchip = Number(document.getElementById("microchipU").value)
                }
                if (isNaN(microchip) || isNaN(pet_id) || document.formU.speciesU[document.formU.speciesU.selectedIndex].text === "Seleccione"
                    || document.formU.sizeU[document.formU.sizeU.selectedIndex].text === "Seleccione" || document.formU.sexU[document.formU.sexU.selectedIndex].text === "Seleccione"
                    || fileD === "unknown") {
                    alert("Los datos ingresados son incorrectos");
                    return;
                }
                var data = {
                    "microchip": microchip,
                    "name": document.getElementById("nameU").value,
                    "species": document.formU.speciesU[document.formU.speciesU.selectedIndex].text,
                    "race": document.getElementById("raceU").value,
                    "size": document.formU.sizeU[document.formU.sizeU.selectedIndex].text,
                    "sex": document.formU.sexU[document.formU.sexU.selectedIndex].text,
                    "picture": fileD
                };
                console.log(data)
                fetch(url, {
                    method: 'PUT',
                    body: JSON.stringify(data), // data can be `string` or {object}!
                    headers: {
                        'Content-Type': 'application/json'
                    }
                }).then(res => res.text())
                    .then(res => validateUpPet(res));
            }

            function validateUpPet(res) {
                if (res === "Se ha modificado exitosamente!") {
                    alert("Se ha modificado la mascota exitosamente!");
                } else {
                    alert(res.toString());
                }
                location.reload();
            }

            /**
             * Get the parameters of the form and send it to the rest in backend for create a case
             */

            Casebutton.onclick = function () {
                var username = findUsername();
                var pet_id = Number(document.getElementById("petidC").value);
                var create_at = document.getElementById("caseDate").value;
                var url = 'http://localhost:8080/FourPawsCitizens-FootprintsSystem-1.0-SNAPSHOT/api/owner/' + username + '/pet/' + pet_id + '/petCases';
                if (document.formCase.typeCase[document.formCase.typeCase.selectedIndex].text === "Seleccione" || isNaN(pet_id)) {
                    alert("Los datos ingresados son incorrectos");
                    return;
                }
                var data = {
                    "created_at": create_at.replace(/^(\d{4})-(\d{2})-(\d{2})$/g, '$3/$2/$1'),
                    "type": document.formCase.typeCase[document.formCase.typeCase.selectedIndex].text,
                    "description": document.getElementById("description").value
                };

                //Send and create a post method in the rest backend
                fetch(url, {
                    method: 'POST',
                    body: JSON.stringify(data), // data can be `string` or {object}!
                    headers: {
                        'Content-Type': 'application/json'
                    }
                }).then(res => res.text())
                    .then(res => validateMessage(res));
            }

            function validateMessage(res) {
                if (res === "se ha registrado correctamente") {
                    alert("Se creo el caso correctamente");
                } else {
                    alert(res.toString());
                }
                location.reload();
            }

            /**
             * Get the parameter of the form and send it to rest in the backend to update the owner's data
             */
            Userbutton.onclick = function () {
                var username = findUsername();
                var url = 'http://localhost:8080/FourPawsCitizens-FootprintsSystem-1.0-SNAPSHOT/api/owner/' + username;
                if (document.formUser.neighborhoodUser[document.formUser.neighborhoodUser.selectedIndex].text === "Seleccione") {
                    alert("Es necesario selecionar una localidad");
                    return;
                }
                var data = {
                    "username": username,
                    "password": null,
                    "email": null,
                    "person_id": 0,
                    "name": null,
                    "address": document.getElementById("addressUser").value,
                    "neighborhood": document.formUser.neighborhoodUser[document.formUser.neighborhoodUser.selectedIndex].text
                };

                //Send and create a put method in the rest backend
                fetch(url, {
                    method: 'PUT',
                    body: JSON.stringify(data), // data can be `string` or {object}!
                    headers: {
                        'Content-Type': 'application/json'
                    }
                }).then(res => res.text())
                    .then(response => console.log('Success:', response));
                alert("Se actualizaron los datos ");
                location.reload();
            }

        </script>

    </div>
</body>

</html>